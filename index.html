<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML5 Network Metrics Tool</title>
    <style>
        :root { --primary: #0066ff; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 40px; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 450px; }
        h2 { margin-top: 0; color: #333; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { color: #666; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; }
        .metric { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.1rem; color: var(--primary); }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; background: var(--primary); color: white; font-size: 1rem; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { text-align: center; margin-top: 15px; font-size: 0.9rem; color: #888; }
    </style>
</head>
<body>

<div class="card">
    <h2>Network Speed Test</h2>
    
    <table>
        <thead>
            <tr>
                <th>Metric</th>
                <th>Result</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Ping (Latency)</td>
                <td><span id="ping-val" class="metric">-</span> ms</td>
            </tr>
            <tr>
                <td>Jitter</td>
                <td><span id="jitter-val" class="metric">-</span> ms</td>
            </tr>
            <tr>
                <td>Download</td>
                <td><span id="download-val" class="metric">-</span> Mbps</td>
            </tr>
        </tbody>
    </table>

    <button id="run-btn" onclick="runTest()">Run Diagnostics</button>
    <div id="status">Ready to test</div>
</div>

<script>
    // Dynatrace specific metrics ingest API
    // sendMetric("custom.page.load.time", performance.now());
    async function sendMetric(metricName, value) {
        const response = await fetch("https://eou37502.live.dynatrace.com/api/v2/metrics/ingest", {
            method: "POST",
            headers: {
                "Authorization": "Api-Token YOUR_API_TOKEN",
                "Content-Type": "application/json"
            },
            body: JSON.stringify([{
                metric: metricName,
                value: value,
                timestamp: Date.now(),
                dimensions: { page: window.location.pathname }
            }])
        });
        if (!response.ok) {
            console.error("Failed to send metric:", response.statusText);
        }
    }
    
    // Using Cloudflare's speed test endpoint (CORS-friendly)
    // We request 10MB to get a sustained average
    const testUrl = "https://speed.cloudflare.com/__down?bytes=10000000";
    const pingUrl = "https://speed.cloudflare.com/cdn-cgi/trace"; // Light file for ping

    async function runTest() {
        const runBtn = document.getElementById('run-btn');
        const status = document.getElementById('status');
        
        // Result DOM Objects
        const pingDom = document.getElementById('ping-val');
        const jitterDom = document.getElementById('jitter-val');
        const downloadDom = document.getElementById('download-val');

        // Reset UI
        runBtn.disabled = true;
        downloadDom.innerText = "-";
        
        try {
            // --- 1. PING & JITTER TEST ---
            status.innerText = "Measuring Latency...";
            let latencies = [];
            for (let i = 0; i < 5; i++) {
                const start = performance.now();
                await fetch(pingUrl + "?cache=" + Math.random());
                const end = performance.now();
                latencies.push(end - start);
                pingDom.innerText = Math.round(latencies.reduce((a, b) => a + b) / latencies.length);
            }

            // Calculate Jitter
            let diffs = [];
            for (let i = 1; i < latencies.length; i++) {
                diffs.push(Math.abs(latencies[i] - latencies[i-1]));
            }
            jitterDom.innerText = (diffs.reduce((a, b) => a + b) / diffs.length).toFixed(2);

            // --- 2. DOWNLOAD SPEED TEST ---
            status.innerText = "Downloading test file (10MB)...";
            const dlStart = performance.now();
            
            const response = await fetch(testUrl + "&cb=" + Math.random());
            if (!response.ok) throw new Error("Network response was not ok");

            const reader = response.body.getReader();
            let receivedLength = 0;

            // Reading stream to avoid CORS "0 byte" issues
            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                receivedLength += value.length;
                
                // Optional: Update UI with progress
                let currentTotal = (receivedLength / (1024 * 1024)).toFixed(1);
                status.innerText = `Downloaded ${currentTotal} MB...`;
            }

            const dlEnd = performance.now();
            const durationSeconds = (dlEnd - dlStart) / 1000;
            const sizeInBits = receivedLength * 8;
            const speedMbps = (sizeInBits / durationSeconds / 1000000).toFixed(2);

            downloadDom.innerText = speedMbps;
            status.innerText = "Test Complete";

            // 3. SHOW POPUP
            status.innerText = "Finished";
            
            // 4. Referencing the DOM objects for the result metrics: ${downloadDom.innerText}, ${pingDom.innerText} and ${jitterDom.innerText}
            alert(`Result: ${downloadDom.innerText}, ${pingDom.innerText} and ${jitterDom.innerText}`);
            // sendMetric("custom.speedtest.download.time", `${downloadDom.innerText}`);
            
        } catch (error) {
            console.error(error);
            status.innerText = "Error: Check CORS or Connection";
        } finally {
            runBtn.disabled = false;
        }
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Speed Test</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f9; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 800px; margin: 40px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        button { padding: 12px 30px; font-size: 18px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 20px 0; }
        button:hover { background: #0056b3; }
        button:disabled { background: #aaa; cursor: not-allowed; }
        table { width: 100%; margin-top: 30px; border-collapse: collapse; }
        th, td { padding: 15px; border: 1px solid #ddd; text-align: left; }
        th { background: #007bff; color: white; }
        .status { margin: 20px 0; font-size: 18px; color: #555; }
        .progress { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Network Speed Test</h1>
        <p>Measures Ping, Jitter, Download, and Upload speeds using your own server.</p>
        <button id="startBtn" onclick="startTest()">Start Test</button>
        <div class="status" id="status">Ready to test</div>

        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>Ping</td><td id="ping">-</td></tr>
                <tr><td>Jitter</td><td id="jitter">-</td></tr>
                <tr><td>Download</td><td id="download">-</td></tr>
                <tr><td>Upload</td><td id="upload">-</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const pingEl = document.getElementById('ping');
        const jitterEl = document.getElementById('jitter');
        const downloadEl = document.getElementById('download');
        const uploadEl = document.getElementById('upload');
        const startBtn = document.getElementById('startBtn');

        function updateStatus(msg) {
            statusEl.innerHTML = `<span class="progress">${msg}</span>`;
        }

        async function startTest() {
            startBtn.disabled = true;
            resetResults();
            updateStatus('Testing Ping & Jitter...');

            await testPingAndJitter();

            updateStatus('Testing Download Speed...');
            await testDownload();

            updateStatus('Testing Upload Speed...');
            await testUpload();

            updateStatus('Test Completed!');
            startBtn.disabled = false;
        }

        function resetResults() {
            pingEl.textContent = jitterEl.textContent = downloadEl.textContent = uploadEl.textContent = '-';
        }

        // Ping & Jitter Test
        async function testPingAndJitter() {
            let pings = [];
            const samples = 20;

            for (let i = 0; i < samples; i++) {
                const start = performance.now();
                try {
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', 'garbage.php?' + Date.now(), false); // Synchronous for simplicity
                    xhr.send();
                    if (xhr.status === 200) {
                        pings.push(performance.now() - start);
                    }
                } catch (e) {}
                await new Promise(r => setTimeout(r, 100)); // Small delay
            }

            if (pings.length > 0) {
                pings.sort((a,b) => a - b);
                const avgPing = pings.reduce((a,b) => a + b) / pings.length;
                let jitter = 0;
                for (let i = 1; i < pings.length; i++) {
                    jitter += Math.abs(pings[i] - pings[i-1]);
                }
                jitter /= (pings.length - 1);

                pingEl.textContent = avgPing.toFixed(1) + ' ms';
                jitterEl.textContent = jitter.toFixed(1) + ' ms';
            } else {
                pingEl.textContent = jitterEl.textContent = 'Failed';
            }
        }

        // Download Test (multi-threaded)
        async function testDownload() {
            const testDuration = 10000; // 10 seconds
            const threads = 6;
            let totalBytes = 0;
            let startTime = performance.now();
            let activeThreads = threads;

            function runThread() {
                const xhr = new XMLHttpRequest();
                xhr.responseType = 'blob';
                xhr.open('GET', `garbage.php?ckSize=25&${Date.now()}`);
                xhr.onprogress = (e) => {
                    if (e.lengthComputable) totalBytes += e.loaded;
                };
                xhr.onload = xhr.onerror = () => {
                    if (--activeThreads === 0) finish();
                };
                xhr.send();
            }

            for (let i = 0; i < threads; i++) runThread();

            const interval = setInterval(() => {
                const elapsed = (performance.now() - startTime) / 1000;
                if (elapsed > 0) {
                    const speed = (totalBytes * 8 / elapsed / 1000000).toFixed(1);
                    downloadEl.textContent = speed + ' Mbps';
                }
            }, 300);

            function finish() {
                clearInterval(interval);
                const elapsed = (performance.now() - startTime) / 1000;
                const speed = (totalBytes * 8 / elapsed / 1000000).toFixed(1);
                downloadEl.textContent = speed + ' Mbps';
            }

            // Fallback timeout
            setTimeout(() => { if (activeThreads > 0) finish(); }, testDuration + 2000);
        }

        // Upload Test (multi-threaded)
        async function testUpload() {
            const blobSize = 10 * 1024 * 1024; // 10 MB per thread
            const blob = new Blob([new Uint8Array(blobSize)]);
            const threads = 4;
            let totalSent = 0;
            let startTime = performance.now();
            let activeThreads = threads;

            function runThread() {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'empty.php');
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) totalSent += e.loaded;
                };
                xhr.onload = xhr.onerror = () => {
                    if (--activeThreads === 0) finish();
                };
                xhr.send(blob);
            }

            for (let i = 0; i < threads; i++) runThread();

            const interval = setInterval(() => {
                const elapsed = (performance.now() - startTime) / 1000;
                if (elapsed > 0) {
                    const speed = (totalSent * 8 / elapsed / 1000000).toFixed(1);
                    uploadEl.textContent = speed + ' Mbps';
                }
            }, 300);

            function finish() {
                clearInterval(interval);
                const elapsed = (performance.now() - startTime) / 1000;
                const speed = (totalSent * 8 / elapsed / 1000000).toFixed(1);
                uploadEl.textContent = speed + ' Mbps';
            }

            // Fallback
            setTimeout(() => { if (activeThreads > 0) finish(); }, 15000);
        }
    </script>
</body>
</html>

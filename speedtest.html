<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced HTML5 Speed Test</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 40px; background-color: #f8f9fa; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        table { border-collapse: collapse; width: 400px; margin-top: 20px; background: white; }
        th, td { border: 1px solid #dee2e6; padding: 15px; text-align: left; }
        th { background-color: #007bff; color: white; }
        .metric-value { font-weight: bold; font-family: monospace; color: #333; }
        button { padding: 12px 24px; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 16px; transition: 0.3s; }
        button:hover { background: #218838; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .status { margin-top: 10px; font-style: italic; color: #666; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Network Performance</h2>
        <button id="start-test" onclick="runSpeedTest()">Start Performance Test</button>
        <div id="status-text" class="status">Ready</div>

        <table>
            <thead>
                <tr>
                    <th>Network Metric</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Ping (Latency)</td>
                    <td><span id="ping-val" class="metric-value">-</span> ms</td>
                </tr>
                <tr>
                    <td>Jitter</td>
                    <td><span id="jitter-val" class="metric-value">-</span> ms</td>
                </tr>
                <tr>
                    <td>Download Speed</td>
                    <td><span id="download-val" class="metric-value">-</span> Mbps</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // Configuration
        const testImage = "https://upload.wikimedia.org/wikipedia/commons/b/b9/A_large_blank_world_map_with_oceans_marked_in_blue.svg";
        const pingIterations = 5;

        async function runSpeedTest() {
            const btn = document.getElementById('start-test');
            const status = document.getElementById('status-text');
            
            // DOM Object References
            const pingDom = document.getElementById('ping-val');
            const jitterDom = document.getElementById('jitter-val');
            const downloadDom = document.getElementById('download-val');

            btn.disabled = true;
            status.innerText = "Testing Ping & Jitter...";

            try {
                // 1. Measure Ping & Jitter
                let pings = [];
                for (let i = 0; i < pingIterations; i++) {
                    const start = performance.now();
                    // Fetch with cache busting and no-cache headers
                    await fetch(testImage + "?cache=" + Math.random(), { mode: 'no-cors', cache: 'no-store' });
                    const end = performance.now();
                    pings.push(end - start);
                    pingDom.innerText = Math.round(pings.reduce((a, b) => a + b) / pings.length);
                }

                // Calculate Jitter (average difference between consecutive pings)
                let jitter = 0;
                if (pings.length > 1) {
                    let diffs = [];
                    for (let i = 1; i < pings.length; i++) {
                        diffs.push(Math.abs(pings[i] - pings[i-1]));
                    }
                    jitter = diffs.reduce((a, b) => a + b) / diffs.length;
                    jitterDom.innerText = jitter.toFixed(2);
                }

                // 2. Measure Download Speed
                status.innerText = "Testing Download Speed...";
                const dlStart = performance.now();
                const response = await fetch(testImage + "?cb=" + Math.random(), { cache: 'no-store' });
                const blob = await response.blob();
                const dlEnd = performance.now();
                
                const durationSeconds = (dlEnd - dlStart) / 1000;
                const sizeInBits = blob.size * 8;
                const speedMbps = (sizeInBits / durationSeconds / (1024 * 1024)).toFixed(2);

                downloadDom.innerText = speedMbps;
                status.innerText = "Test Complete.";

            } catch (error) {
                status.innerText = "Error encountered.";
                console.error(error);
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
